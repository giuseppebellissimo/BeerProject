{% load static %}
{% load crispy_forms_filters %}

{% block content %}
    {% spaceless %}
        {% if user.is_authenticated %}
            <form method="post" id="step-form" action="{% url 'add-step-recipe' recipe_id %}">
                <h3>Recipe Steps</h3>
                <table class="table table-striped">
                    {% csrf_token %}
                    {{ step_form.management_form }}
                    {% for form in step_form.forms %}
                        {% if forloop.first %}
                            <thead>
                            <tr>
                                {% for field in form.visible_fields %}
                                    <th>{{ field.label|capfirst }}</th>
                                {% endfor %}
                            </tr>
                            </thead>
                        {% endif %}
                        <tr class="{% cycle 'row1' 'row2' %} step_formset_row">
                            {% for field in form.visible_fields %}
                                <td>
                                    {% if forloop.first %}
                                        {% for hidden in form.hidden_fields %}
                                            {{ hidden }}
                                        {% endfor %}
                                    {% endif %}
                                    {{ field.errors.as_ul }}
                                    {{ field }}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </table>
                <div role="group" style="margin-bottom: 10px">
                    <button class="btn btn-outline-success" type="submit" id="saveStepButton"
                            style="margin-bottom: 15px" data-url="{% url 'add-step-recipe' recipe_id %}">Save Step
                    </button>
                    <a class="btn btn-link" type="button" href="{% url 'home' %}">Back Home</a>
                </div>
            </form>
        {% endif %}

        <script src="{% static 'formset/jquery_formset.js' %}"></script>
        <script type="text/javascript">
            $(function () {
                $('.step_formset_row').formset({
                    prefix: 'step',
                    addText: 'Add',
                    deleteText: 'Delete',
                    formCssClass: 'dynamic-formset1',
                    addCssClass: 'add-row btn btn-primary',
                    deleteCssClass: 'delete-row btn btn-danger',
                });
            });

            $('#saveStepButton').on('click', function () {
                const form_data = new FormData();
                form_data.append('csrfmiddlewaretoken', document.getElementsByName('csrfmiddlewaretoken')[0].value);

                $('#step-form .step_formset_row').each(function (index) {
                    $(this).find(':input').each(function () {
                        let fieldName = $(this).attr('name').replace(/-\d+-/, `-${index}-`);
                        form_data.append(fieldName, $(this).val());
                    });
                });

                $('#step-form').find(':input[name$="-TOTAL_FORMS"], :input[name$="-INITIAL_FORMS"], :input[name$="-MIN_NUM_FORMS"], :input[name$="-MAX_NUM_FORMS"]').each(function () {
                    form_data.append($(this).attr('name'), $(this).val());
                });

                let url = $(this).data('url');
                $.ajax({
                    type: 'POST',
                    url: url,
                    data: form_data,
                    success: function (response) {
                        $('#message-content').text('Step added successfully');
                        $('#message-container').removeClass('d-none alert-danger').addClass('alert-success show');
                        document.getElementById('step-form').reset();
                        console.log(response);
                    },
                    error: function (error) {
                        $('#message-content').text('An error occurred. Please try again.');
                        $('#message-container').removeClass('d-none alert-success').addClass('alert-danger show');
                        console.log(error);
                    },
                    contentType: false,
                    processData: false,
                });
                event.preventDefault();
            })
        </script>
    {% endspaceless %}
{% endblock %}

